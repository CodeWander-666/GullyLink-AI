<!DOCTYPE html>
<html>
<head>
    <title>GullyLink - Vendor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }
        #sidebar { width: 300px; background: #f4f4f4; padding: 20px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #map { flex-grow: 1; }
        .card { background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-accept { background: green; color: white; border: none; padding: 5px; width: 100%; cursor: pointer; margin-top: 5px; }
        .btn-reject { background: red; color: white; border: none; padding: 5px; width: 100%; cursor: pointer; margin-top: 5px; }
        .toggle-move { margin-bottom: 20px; padding: 10px; background: #333; color: white; cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Vendor Dashboard</h2>
        <select id="vendorSelect" style="width:100%; padding:10px; margin-bottom:10px;">
            <option value="v1">Chai Point (v1)</option>
            <option value="v2">Burger Singh (v2)</option>
            <option value="v3">Sharma Sweets (v3)</option>
            <option value="v4">Pizza Hut (v4)</option>
            <option value="v5">Gully Momos (v5)</option>
        </select>
        
        <div class="toggle-move" onclick="toggleMovement()">ðŸš€ Toggle Moving Simulation</div>
        
        <h3>Incoming Orders</h3>
        <div id="ordersList">No orders yet...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([28.6139, 77.2090], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        let currentVendorId = "v1";
        let isMoving = false;
        let moveInterval = null;
        let myMarker = null;
        let currentLat = 28.6139;
        let currentLng = 77.2090;

        document.getElementById('vendorSelect').addEventListener('change', (e) => {
            currentVendorId = e.target.value;
            alert("Switched to " + currentVendorId);
        });

        // Handle Incoming Orders
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'new_order' && data.vendor_id === currentVendorId) {
                addOrderCard(data.order);
            }
        };

        function addOrderCard(order) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <strong>Order #${order.id}</strong><br>
                Item: ${order.item}<br>
                Status: ${order.status}<br>
                <button class="btn-accept" onclick="updateStatus(${order.id}, 'Accepted')">Accept</button>
                <button class="btn-reject" onclick="updateStatus(${order.id}, 'Rejected')">Reject</button>
            `;
            document.getElementById('ordersList').prepend(div);
            
            // Show Order Location on Map
            L.marker([order.lat, order.lng]).addTo(map).bindPopup(`Order #${order.id} Location`).openPopup();
        }

        function updateStatus(orderId, status) {
            ws.send(JSON.stringify({
                type: "order_update",
                order_id: orderId,
                status: status
            }));
        }

        // --- Moving Simulation ---
        function toggleMovement() {
            isMoving = !isMoving;
            if (isMoving) {
                moveInterval = setInterval(() => {
                    // Jitter location slightly to simulate movement
                    currentLat += (Math.random() - 0.5) * 0.001;
                    currentLng += (Math.random() - 0.5) * 0.001;
                    
                    if (myMarker) map.removeLayer(myMarker);
                    myMarker = L.marker([currentLat, currentLng]).addTo(map);

                    // Send new location to server
                    ws.send(JSON.stringify({
                        type: "location_update",
                        id: currentVendorId,
                        lat: currentLat,
                        lng: currentLng,
                        icon: "ðŸšš" // Dynamic icon
                    }));
                }, 2000); // Update every 2 seconds
            } else {
                clearInterval(moveInterval);
            }
        }
    </script>
</body>
</html>
